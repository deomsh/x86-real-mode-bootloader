name: Bootloader Emulator Trace

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  emulate-and-trace:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install icicle-emu

    - name: Install NASM
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm

    - name: Compile simple bootloader
      run: |
        echo "Compiling simple_boot.asm..."
        nasm -f bin simple_boot.asm -o simple_boot.bin
        ls -lh simple_boot.bin
        echo "Verifying boot signature..."
        xxd -l 512 -c 16 simple_boot.bin | tail -2

    - name: Run emulator with instruction trace
      run: |
        echo "=========================================="
        echo "Running Bootloader Emulator"
        echo "=========================================="
        python3 emulator.py simple_boot.bin -m 50 -o trace.json 2>&1 | grep -v "DEBUG"

    - name: Display trace summary
      run: |
        echo ""
        echo "=========================================="
        echo "Trace File Contents"
        echo "=========================================="
        python3 << 'EOF'
        import json

        with open('trace.json', 'r') as f:
            data = json.load(f)

        print(f"Binary: {data['metadata']['binary']}")
        print(f"Boot Address: {data['metadata']['boot_address']}")
        print(f"Total Instructions: {data['metadata']['total_instructions']}")
        print(f"\nFirst 10 instructions:\n")

        for entry in data['trace'][:10]:
            pc = entry['pc']
            step = entry['step']
            regs = entry['registers']
            print(f"Step {step:03d}: PC=0x{pc:04X} | {entry['bytes']}")
            print(f"         RAX=0x{regs['rax']:08X} RBX=0x{regs['rbx']:08X} RCX=0x{regs['rcx']:08X}")
        EOF

    - name: Upload trace artifact
      uses: actions/upload-artifact@v4
      with:
        name: emulator-trace
        path: trace.json
        retention-days: 30

    - name: Test different bootloader scenarios
      run: |
        echo ""
        echo "=========================================="
        echo "Testing with different instruction limits"
        echo "=========================================="
        echo ""
        echo "--- Running with 10 instructions ---"
        python3 emulator.py simple_boot.bin -m 10 -q 2>&1 | grep -E "^\[|Total|Final PC" | grep -v "DEBUG"
        echo ""
        echo "--- Running with 100 instructions ---"
        python3 emulator.py simple_boot.bin -m 100 -q 2>&1 | grep -E "^\[|Total|Final PC" | grep -v "DEBUG"
