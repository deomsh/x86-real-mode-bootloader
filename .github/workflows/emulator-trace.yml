name: Bootloader Emulator Trace

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  emulate-and-trace:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/mrexodia/x86-real-mode-bootloader:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install additional utilities
      run: |
        apt-get update
        apt-get install -y xxd file python3-pip
        pip3 install --no-cache-dir --break-system-packages unicorn capstone

    - name: Compile simple bootloader
      run: |
        echo "=========================================="
        echo "Compiling simple_boot.asm..."
        echo "=========================================="
        nasm -f bin simple_boot.asm -o simple_boot.bin
        ls -lh simple_boot.bin
        echo "Verifying boot signature..."
        xxd -l 512 -c 16 simple_boot.bin | tail -2

    - name: Compile real FAT bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Compiling boot.c (FAT bootloader)..."
        echo "=========================================="
        make boot boot.img
        ls -lh boot boot.img
        echo "Boot sector signature:"
        xxd -l 512 -c 16 boot | tail -2
        echo "Boot image info:"
        file boot.img

    - name: Run emulator on simple bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Running Emulator on simple_boot.bin"
        echo "=========================================="
        python3 emulator.py simple_boot.bin -o trace_simple.txt

    - name: Run emulator on FAT bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Running Emulator on boot (FAT bootloader)"
        echo "=========================================="
        python3 emulator.py boot -d boot.img -o trace_fat.txt

    - name: Upload trace artifacts
      uses: actions/upload-artifact@v4
      with:
        name: emulator-traces
        path: |
          trace_simple.txt
          trace_fat.txt
        retention-days: 30

    - name: Display execution statistics
      run: |
        echo ""
        echo "=========================================="
        echo "Execution Statistics"
        echo "=========================================="
        echo ""
        echo "Simple bootloader:"
        echo "  Instructions executed: $(wc -l < trace_simple.txt)"
        echo "  First 30 instructions:"
        head -30 trace_simple.txt
        echo ""
        echo "=========================================="
        echo ""
        echo "FAT bootloader:"
        echo "  Instructions executed: $(wc -l < trace_fat.txt)"
        echo "  INT 0x10 calls: $(grep -c 'int 0x10' trace_fat.txt || echo 0)"
        echo "  INT 0x13 calls: $(grep -c 'int 0x13' trace_fat.txt || echo 0)"
        echo "  Memory accesses: $(grep -c 'mem\[' trace_fat.txt || echo 0)"
        echo ""
        echo "  First 50 instructions:"
        head -50 trace_fat.txt
        echo ""
        echo "  Last 20 instructions:"
        tail -20 trace_fat.txt
